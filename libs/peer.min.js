!function(e){function t(){this._pieces=[],this._parts=[]}function n(e){this.index=0,this.dataBuffer=e,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}function i(e){this.utf8=e,this.bufferBuilder=new t}function r(){this._events={}}function o(e,t){return this instanceof o?(this._dc=e,l.debug=t,this._outgoing={},this._incoming={},this._received={},this._window=1e3,this._mtu=500,this._interval=0,this._count=0,this._queue=[],this._setupDC(),void 0):new o(e)}function s(e,t){if(!(this instanceof s))return new s(e,t);if(r.call(this),e&&e.constructor==Object?(t=e,e=void 0):e&&(e=e.toString()),t=l.extend({debug:0,host:l.CLOUD_HOST,port:l.CLOUD_PORT,key:"peerjs",config:l.defaultConfig},t),this.options=t,"/"===t.host&&(t.host=window.location.hostname),void 0===t.secure&&t.host!==l.CLOUD_HOST&&(t.secure=l.isSecure()),t.logFunction&&l.setLogFunction(t.logFunction),l.setLogLevel(t.debug),!l.supports.audioVideo&&!l.supports.data)return this._delayedAbort("browser-incompatible","The current browser does not support WebRTC"),void 0;if(!l.validateId(e))return this._delayedAbort("invalid-id",'ID "'+e+'" is invalid'),void 0;if(!l.validateKey(t.key))return this._delayedAbort("invalid-key",'API KEY "'+t.key+'" is invalid'),void 0;if(t.secure&&"0.peerjs.com"===t.host)return this._delayedAbort("ssl-unavailable","The cloud server currently does not support HTTPS. Please run your own PeerServer to use HTTPS."),void 0;this.destroyed=!1,this.disconnected=!1,this.open=!1,this.connections={},this._lostMessages={};var n=this;this.socket=new u(this.options.secure,this.options.host,this.options.port,this.options.key),this.socket.on("message",function(e){n._handleMessage(e)}),this.socket.on("error",function(e){n._abort("socket-error",e)}),this.socket.on("close",function(){n.disconnected||n._abort("socket-closed","Underlying socket is already closed.")}),e?this._initialize(e):this._retrieveId()}function a(e,t,n){return this instanceof a?(r.call(this),this.options=l.extend({serialization:"binary",reliable:!0},n),this.open=!1,this.type="data",this.peer=e,this.provider=t,this.id=this.options.connectionId||a._idPrefix+l.randomToken(),this.label=this.options.label||this.id,this.metadata=this.options.metadata,this.serialization=this.options.serialization,this.reliable=this.options.reliable,f.startConnection(this,this.options._payload||{originator:!0}),void 0):new a(e,t,n)}function c(e,t,n){return this instanceof c?(r.call(this),this.options=l.extend({},n),this.open=!1,this.type="media",this.peer=e,this.provider=t,this.metadata=this.options.metadata,this.localStream=this.options._stream,this.id=this.options.connectionId||c._idPrefix+l.randomToken(),this.localStream&&f.startConnection(this,{_stream:this.localStream,originator:!0}),void 0):new c(e,t,n)}function u(e,t,n,i){if(!(this instanceof u))return new u(e,t,n,i);r.call(this),this.disconnected=!1,this._queue=[];var o=e?"https://":"http://",s=e?"wss://":"ws://";this._httpUrl=o+t+":"+n+"/"+i,this._wsUrl=s+t+":"+n+"/peerjs?key="+i}var p={};p.useBlobBuilder=function(){try{return new Blob([]),!1}catch(e){return!0}}(),p.useArrayBufferView=!p.useBlobBuilder&&function(){try{return 0===new Blob([new Uint8Array([])]).size}catch(e){return!0}}(),e.binaryFeatures=p,e.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder,t.prototype.append=function(e){"number"==typeof e?this._pieces.push(e):(this._flush(),this._parts.push(e))},t.prototype._flush=function(){if(this._pieces.length>0){var e=new Uint8Array(this._pieces);p.useArrayBufferView||(e=e.buffer),this._parts.push(e),this._pieces=[]}},t.prototype.getBuffer=function(){if(this._flush(),p.useBlobBuilder){for(var e=new BlobBuilder,t=0,n=this._parts.length;n>t;t++)e.append(this._parts[t]);return e.getBlob()}return new Blob(this._parts)},e.BinaryPack={unpack:function(e){var t=new n(e);return t.unpack()},pack:function(e,t){var n=new i(t),r=n.pack(e);return r}},n.prototype.unpack=function(){var e=this.unpack_uint8();if(128>e){var t=e;return t}if(32>(224^e)){var n=(224^e)-32;return n}var i;if((i=160^e)<=15)return this.unpack_raw(i);if((i=176^e)<=15)return this.unpack_string(i);if((i=144^e)<=15)return this.unpack_array(i);if((i=128^e)<=15)return this.unpack_map(i);switch(e){case 192:return null;case 193:return void 0;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return void 0;case 213:return void 0;case 214:return void 0;case 215:return void 0;case 216:return i=this.unpack_uint16(),this.unpack_string(i);case 217:return i=this.unpack_uint32(),this.unpack_string(i);case 218:return i=this.unpack_uint16(),this.unpack_raw(i);case 219:return i=this.unpack_uint32(),this.unpack_raw(i);case 220:return i=this.unpack_uint16(),this.unpack_array(i);case 221:return i=this.unpack_uint32(),this.unpack_array(i);case 222:return i=this.unpack_uint16(),this.unpack_map(i);case 223:return i=this.unpack_uint32(),this.unpack_map(i)}},n.prototype.unpack_uint8=function(){var e=255&this.dataView[this.index];return this.index++,e},n.prototype.unpack_uint16=function(){var e=this.read(2),t=256*(255&e[0])+(255&e[1]);return this.index+=2,t},n.prototype.unpack_uint32=function(){var e=this.read(4),t=256*(256*(256*e[0]+e[1])+e[2])+e[3];return this.index+=4,t},n.prototype.unpack_uint64=function(){var e=this.read(8),t=256*(256*(256*(256*(256*(256*(256*e[0]+e[1])+e[2])+e[3])+e[4])+e[5])+e[6])+e[7];return this.index+=8,t},n.prototype.unpack_int8=function(){var e=this.unpack_uint8();return 128>e?e:e-256},n.prototype.unpack_int16=function(){var e=this.unpack_uint16();return 32768>e?e:e-65536},n.prototype.unpack_int32=function(){var e=this.unpack_uint32();return e<Math.pow(2,31)?e:e-Math.pow(2,32)},n.prototype.unpack_int64=function(){var e=this.unpack_uint64();return e<Math.pow(2,63)?e:e-Math.pow(2,64)},n.prototype.unpack_raw=function(e){if(this.length<this.index+e)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+e+" "+this.length);var t=this.dataBuffer.slice(this.index,this.index+e);return this.index+=e,t},n.prototype.unpack_string=function(e){for(var t,n,i=this.read(e),r=0,o="";e>r;)t=i[r],128>t?(o+=String.fromCharCode(t),r++):32>(192^t)?(n=(192^t)<<6|63&i[r+1],o+=String.fromCharCode(n),r+=2):(n=(15&t)<<12|(63&i[r+1])<<6|63&i[r+2],o+=String.fromCharCode(n),r+=3);return this.index+=e,o},n.prototype.unpack_array=function(e){for(var t=new Array(e),n=0;e>n;n++)t[n]=this.unpack();return t},n.prototype.unpack_map=function(e){for(var t={},n=0;e>n;n++){var i=this.unpack(),r=this.unpack();t[i]=r}return t},n.prototype.unpack_float=function(){var e=this.unpack_uint32(),t=e>>31,n=(255&e>>23)-127,i=8388608|8388607&e;return(0==t?1:-1)*i*Math.pow(2,n-23)},n.prototype.unpack_double=function(){var e=this.unpack_uint32(),t=this.unpack_uint32(),n=e>>31,i=(2047&e>>20)-1023,r=1048576|1048575&e,o=r*Math.pow(2,i-20)+t*Math.pow(2,i-52);return(0==n?1:-1)*o},n.prototype.read=function(e){var t=this.index;if(t+e<=this.length)return this.dataView.subarray(t,t+e);throw new Error("BinaryPackFailure: read index out of range")},i.prototype.pack=function(e){var t=typeof e;if("string"==t)this.pack_string(e);else if("number"==t)Math.floor(e)===e?this.pack_integer(e):this.pack_double(e);else if("boolean"==t)e===!0?this.bufferBuilder.append(195):e===!1&&this.bufferBuilder.append(194);else if("undefined"==t)this.bufferBuilder.append(192);else{if("object"!=t)throw new Error('Type "'+t+'" not yet supported');if(null===e)this.bufferBuilder.append(192);else{var n=e.constructor;if(n==Array)this.pack_array(e);else if(n==Blob||n==File)this.pack_bin(e);else if(n==ArrayBuffer)p.useArrayBufferView?this.pack_bin(new Uint8Array(e)):this.pack_bin(e);else if("BYTES_PER_ELEMENT"in e)p.useArrayBufferView?this.pack_bin(e):this.pack_bin(e.buffer);else if(n==Object)this.pack_object(e);else if(n==Date)this.pack_string(e.toString());else{if("function"!=typeof e.toBinaryPack)throw new Error('Type "'+n.toString()+'" not yet supported');this.bufferBuilder.append(e.toBinaryPack())}}}return this.bufferBuilder.getBuffer()},i.prototype.pack_bin=function(e){var t=e.length||e.byteLength||e.size;if(15>=t)this.pack_uint8(160+t);else if(65535>=t)this.bufferBuilder.append(218),this.pack_uint16(t);else{if(!(4294967295>=t))throw new Error("Invalid length");this.bufferBuilder.append(219),this.pack_uint32(t)}this.bufferBuilder.append(e)},i.prototype.pack_string=function(e){var t;if(this.utf8){var n=new Blob([e]);t=n.size}else t=e.length;if(15>=t)this.pack_uint8(176+t);else if(65535>=t)this.bufferBuilder.append(216),this.pack_uint16(t);else{if(!(4294967295>=t))throw new Error("Invalid length");this.bufferBuilder.append(217),this.pack_uint32(t)}this.bufferBuilder.append(e)},i.prototype.pack_array=function(e){var t=e.length;if(15>=t)this.pack_uint8(144+t);else if(65535>=t)this.bufferBuilder.append(220),this.pack_uint16(t);else{if(!(4294967295>=t))throw new Error("Invalid length");this.bufferBuilder.append(221),this.pack_uint32(t)}for(var n=0;t>n;n++)this.pack(e[n])},i.prototype.pack_integer=function(e){if(e>=-32&&127>=e)this.bufferBuilder.append(255&e);else if(e>=0&&255>=e)this.bufferBuilder.append(204),this.pack_uint8(e);else if(e>=-128&&127>=e)this.bufferBuilder.append(208),this.pack_int8(e);else if(e>=0&&65535>=e)this.bufferBuilder.append(205),this.pack_uint16(e);else if(e>=-32768&&32767>=e)this.bufferBuilder.append(209),this.pack_int16(e);else if(e>=0&&4294967295>=e)this.bufferBuilder.append(206),this.pack_uint32(e);else if(e>=-2147483648&&2147483647>=e)this.bufferBuilder.append(210),this.pack_int32(e);else if(e>=-0x8000000000000000&&0x8000000000000000>=e)this.bufferBuilder.append(211),this.pack_int64(e);else{if(!(e>=0&&0x10000000000000000>=e))throw new Error("Invalid integer");this.bufferBuilder.append(207),this.pack_uint64(e)}},i.prototype.pack_double=function(e){var t=0;0>e&&(t=1,e=-e);var n=Math.floor(Math.log(e)/Math.LN2),i=e/Math.pow(2,n)-1,r=Math.floor(i*Math.pow(2,52)),o=Math.pow(2,32),s=t<<31|n+1023<<20|1048575&r/o,a=r%o;this.bufferBuilder.append(203),this.pack_int32(s),this.pack_int32(a)},i.prototype.pack_object=function(e){var t=Object.keys(e),n=t.length;if(15>=n)this.pack_uint8(128+n);else if(65535>=n)this.bufferBuilder.append(222),this.pack_uint16(n);else{if(!(4294967295>=n))throw new Error("Invalid length");this.bufferBuilder.append(223),this.pack_uint32(n)}for(var i in e)e.hasOwnProperty(i)&&(this.pack(i),this.pack(e[i]))},i.prototype.pack_uint8=function(e){this.bufferBuilder.append(e)},i.prototype.pack_uint16=function(e){this.bufferBuilder.append(e>>8),this.bufferBuilder.append(255&e)},i.prototype.pack_uint32=function(e){var t=4294967295&e;this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t)},i.prototype.pack_uint64=function(e){var t=e/Math.pow(2,32),n=e%Math.pow(2,32);this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t),this.bufferBuilder.append((4278190080&n)>>>24),this.bufferBuilder.append((16711680&n)>>>16),this.bufferBuilder.append((65280&n)>>>8),this.bufferBuilder.append(255&n)},i.prototype.pack_int8=function(e){this.bufferBuilder.append(255&e)},i.prototype.pack_int16=function(e){this.bufferBuilder.append((65280&e)>>8),this.bufferBuilder.append(255&e)},i.prototype.pack_int32=function(e){this.bufferBuilder.append(255&e>>>24),this.bufferBuilder.append((16711680&e)>>>16),this.bufferBuilder.append((65280&e)>>>8),this.bufferBuilder.append(255&e)},i.prototype.pack_int64=function(e){var t=Math.floor(e/Math.pow(2,32)),n=e%Math.pow(2,32);this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t),this.bufferBuilder.append((4278190080&n)>>>24),this.bufferBuilder.append((16711680&n)>>>16),this.bufferBuilder.append((65280&n)>>>8),this.bufferBuilder.append(255&n)};var h=Array.isArray;r.prototype.addListener=function(e,t){if("function"!=typeof t)throw new Error("addListener only takes instances of Function");return this.emit("newListener",e,"function"==typeof t.listener?t.listener:t),this._events[e]?h(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){function n(){i.removeListener(e,n),t.apply(this,arguments)}if("function"!=typeof t)throw new Error(".once only takes instances of Function");var i=this;return n.listener=t,i.on(e,n),this},r.prototype.removeListener=function(e,t){if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");if(!this._events[e])return this;var n=this._events[e];if(h(n)){for(var i=-1,r=0,o=n.length;o>r;r++)if(n[r]===t||n[r].listener&&n[r].listener===t){i=r;break}if(0>i)return this;n.splice(i,1),0==n.length&&delete this._events[e]}else(n===t||n.listener&&n.listener===t)&&delete this._events[e];return this},r.prototype.off=r.prototype.removeListener,r.prototype.removeAllListeners=function(e){return 0===arguments.length?(this._events={},this):(e&&this._events&&this._events[e]&&(this._events[e]=null),this)},r.prototype.listeners=function(e){return this._events[e]||(this._events[e]=[]),h(this._events[e])||(this._events[e]=[this._events[e]]),this._events[e]},r.prototype.emit=function(e){var e=arguments[0],t=this._events[e];if(!t)return!1;if("function"==typeof t){switch(arguments.length){case 1:t.call(this);break;case 2:t.call(this,arguments[1]);break;case 3:t.call(this,arguments[1],arguments[2]);break;default:for(var n=arguments.length,i=new Array(n-1),r=1;n>r;r++)i[r-1]=arguments[r];t.apply(this,i)}return!0}if(h(t)){for(var n=arguments.length,i=new Array(n-1),r=1;n>r;r++)i[r-1]=arguments[r];for(var o=t.slice(),r=0,n=o.length;n>r;r++)o[r].apply(this,i);return!0}return!1},o.prototype.send=function(e){var t=l.pack(e);return t.size<this._mtu?(this._handleSend(["no",t]),void 0):(this._outgoing[this._count]={ack:0,chunks:this._chunk(t)},l.debug&&(this._outgoing[this._count].timer=new Date),this._sendWindowedChunks(this._count),this._count+=1,void 0)},o.prototype._setupInterval=function(){var e=this;this._timeout=setInterval(function(){var t=e._queue.shift();if(t._multiple)for(var n=0,i=t.length;i>n;n+=1)e._intervalSend(t[n]);else e._intervalSend(t)},this._interval)},o.prototype._intervalSend=function(e){var t=this;e=l.pack(e),l.blobToBinaryString(e,function(e){t._dc.send(e)}),0===t._queue.length&&(clearTimeout(t._timeout),t._timeout=null)},o.prototype._processAcks=function(){for(var e in this._outgoing)this._outgoing.hasOwnProperty(e)&&this._sendWindowedChunks(e)},o.prototype._handleSend=function(e){for(var t=!0,n=0,i=this._queue.length;i>n;n+=1){var r=this._queue[n];r===e?t=!1:r._multiple&&-1!==r.indexOf(e)&&(t=!1)}t&&(this._queue.push(e),this._timeout||this._setupInterval())},o.prototype._setupDC=function(){var e=this;this._dc.onmessage=function(t){var n=t.data,i=n.constructor;if(i===String){var r=l.binaryStringToArrayBuffer(n);n=l.unpack(r),e._handleMessage(n)}}},o.prototype._handleMessage=function(e){var t,n=e[1],i=this._incoming[n],r=this._outgoing[n];switch(e[0]){case"no":var o=n;o&&this.onmessage(l.unpack(o));break;case"end":if(t=i,this._received[n]=e[2],!t)break;this._ack(n);break;case"ack":if(t=r){var s=e[2];t.ack=Math.max(s,t.ack),t.ack>=t.chunks.length?(l.log("Time: ",new Date-t.timer),delete this._outgoing[n]):this._processAcks()}break;case"chunk":if(t=i,!t){var a=this._received[n];if(a===!0)break;t={ack:["ack",n,0],chunks:[]},this._incoming[n]=t}var c=e[2],u=e[3];t.chunks[c]=new Uint8Array(u),c===t.ack[2]&&this._calculateNextAck(n),this._ack(n);break;default:this._handleSend(e)}},o.prototype._chunk=function(e){for(var t=[],n=e.size,i=0;n>i;){var r=Math.min(n,i+this._mtu),o=e.slice(i,r),s={payload:o};t.push(s),i=r}return l.log("Created",t.length,"chunks."),t},o.prototype._ack=function(e){var t=this._incoming[e].ack;this._received[e]===t[2]&&(this._complete(e),this._received[e]=!0),this._handleSend(t)},o.prototype._calculateNextAck=function(e){for(var t=this._incoming[e],n=t.chunks,i=0,r=n.length;r>i;i+=1)if(void 0===n[i])return t.ack[2]=i,void 0;t.ack[2]=n.length},o.prototype._sendWindowedChunks=function(e){l.log("sendWindowedChunks for: ",e);for(var t=this._outgoing[e],n=t.chunks,i=[],r=Math.min(t.ack+this._window,n.length),o=t.ack;r>o;o+=1)n[o].sent&&o!==t.ack||(n[o].sent=!0,i.push(["chunk",e,o,n[o].payload]));t.ack+this._window>=n.length&&i.push(["end",e,n.length]),i._multiple=!0,this._handleSend(i)},o.prototype._complete=function(e){l.log("Completed called for",e);var t=this,n=this._incoming[e].chunks,i=new Blob(n);l.blobToArrayBuffer(i,function(e){t.onmessage(l.unpack(e))}),delete this._incoming[e]},o.higherBandwidthSDP=function(e){var t=e.split("b=AS:30"),n="b=AS:102400";return t[0]+n+t[1]},o.prototype.onmessage=function(){},e.Reliable=o,e.RTCSessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,e.RTCPeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection,e.RTCIceCandidate=window.mozRTCIceCandidate||window.RTCIceCandidate;var d={iceServers:[{url:"stun:stun.l.google.com:19302"}]},l={noop:function(){},CLOUD_HOST:"0.peerjs.com",CLOUD_PORT:9e3,logLevel:0,setLogLevel:function(e){var t=parseInt(e,10);l.logLevel=isNaN(parseInt(e,10))?e?3:0:t,l.log=l.warn=l.error=l.noop,l.logLevel>0&&(l.error=l._printWith("ERROR")),l.logLevel>1&&(l.warn=l._printWith("WARNING")),l.logLevel>2&&(l.log=l._print)},setLogFunction:function(e){e.constructor!==Function?l.warn("The log function you passed in is not a function. Defaulting to regular logs."):l._print=e},_printWith:function(e){return function(){var t=Array.prototype.slice.call(arguments);t.unshift(e),l._print.apply(l,t)}},_print:function(){var e=!1,t=Array.prototype.slice.call(arguments);t.unshift("PeerJS: ");for(var n=0,i=t.length;i>n;n++)t[n]instanceof Error&&(t[n]="("+t[n].name+") "+t[n].message,e=!0);e?console.error.apply(console,t):console.log.apply(console,t)},defaultConfig:d,browser:function(){return window.mozRTCPeerConnection?"Firefox":window.webkitRTCPeerConnection?"Chrome":window.RTCPeerConnection?"Supported":"Unsupported"}(),supports:function(){var e,t,n=!0,i=!0;try{e=new RTCPeerConnection(d,{optional:[{RtpDataChannels:!0}]})}catch(r){n=!1,i=!1}if(n)try{t=e.createDataChannel("_PEERJSDATATEST")}catch(r){n=!1}return i&&(i=!!e.addStream),e.close(),t.close(),{audioVideo:i,data:n,binary:n&&function(){var e=new RTCPeerConnection(d,{optional:[{RtpDataChannels:!0}]}),t=e.createDataChannel("_PEERJSBINARYTEST");try{t.binaryType="blob"}catch(n){if(e.close(),"NotSupportedError"===n.name)return!1}return e.close(),t.close(),!0}(),reliable:n&&function(){var e,t=new RTCPeerConnection(d,{});try{e=t.createDataChannel("_PEERJSRELIABLETEST",{maxRetransmits:0})}catch(n){if(t.close(),"NotSupportedError"===n.name)return!1}return t.close(),e.close(),!0}(),onnegotiationneeded:(n||i)&&function(){var e=new RTCPeerConnection(d,{}),t=!1,e=new RTCPeerConnection(d,{optional:[{RtpDataChannels:!0}]});e.onnegotiationneeded=function(){t=!0,l&&l.supports&&(l.supports.onnegotiationneeded=!0)};var n=e.createDataChannel("_PEERJSRELIABLETEST");return e.close(),n.close(),t}()}}(),validateId:function(e){return!e||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(e)},validateKey:function(e){return!e||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(e)},debug:!1,inherits:function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},pack:BinaryPack.pack,unpack:BinaryPack.unpack,log:function(){if(l.debug){var e=!1,t=Array.prototype.slice.call(arguments);t.unshift("PeerJS: ");for(var n=0,i=t.length;i>n;n++)t[n]instanceof Error&&(t[n]="("+t[n].name+") "+t[n].message,e=!0);e?console.error.apply(console,t):console.log.apply(console,t)}},setZeroTimeout:function(e){function t(t){i.push(t),e.postMessage(r,"*")}function n(t){t.source==e&&t.data==r&&(t.stopPropagation&&t.stopPropagation(),i.length&&i.shift()())}var i=[],r="zero-timeout-message";return e.addEventListener?e.addEventListener("message",n,!0):e.attachEvent&&e.attachEvent("onmessage",n),t}(this),blobToArrayBuffer:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsArrayBuffer(e)},blobToBinaryString:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsBinaryString(e)},binaryStringToArrayBuffer:function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=255&e.charCodeAt(n);return t.buffer},randomToken:function(){return Math.random().toString(36).substr(2)},isSecure:function(){return"https:"===location.protocol}};e.util=l,l.inherits(s,r),s.prototype._retrieveId=function(){var e=this,t=new XMLHttpRequest,n=this.options.secure?"https://":"http://",i=n+this.options.host+":"+this.options.port+"/"+this.options.key+"/id",r="?ts="+(new Date).getTime()+Math.random();i+=r,t.open("get",i,!0),t.onerror=function(t){l.error("Error retrieving ID",t),e._abort("server-error","Could not get an ID from the server")},t.onreadystatechange=function(){return 4===t.readyState?200!==t.status?(t.onerror(),void 0):(e._initialize(t.responseText),void 0):void 0},t.send(null)},s.prototype._initialize=function(e){this.id=e,this.socket.start(this.id)},s.prototype._handleMessage=function(e){var t=e.type,n=e.payload,i=e.src;switch(t){case"OPEN":this.emit("open",this.id),this.open=!0;break;case"ERROR":this._abort("server-error",n.msg);break;case"ID-TAKEN":this._abort("unavailable-id","ID `"+this.id+"` is taken");break;case"INVALID-KEY":this._abort("invalid-key",'API KEY "'+this._key+'" is invalid');break;case"LEAVE":l.log("Received leave message from",i),this._cleanupPeer(i);break;case"EXPIRE":this.emit("error",new Error("Could not connect to peer "+i));break;case"OFFER":var r=n.connectionId,o=this.getConnection(i,r);if(o)l.warn("Offer received for existing Connection ID:",r);else{if("media"===n.type){var o=new c(i,this,{connectionId:r,_payload:n,metadata:n.metadata});this._addConnection(i,o),this.emit("call",o)}else{if("data"!==n.type)return l.warn("Received malformed connection type:",n.type),void 0;o=new a(i,this,{connectionId:r,_payload:n,metadata:n.metadata,label:n.label,serialization:n.serialization,reliable:n.reliable}),this._addConnection(i,o),this.emit("connection",o)}for(var s=this._getMessages(r),u=0,p=s.length;p>u;u+=1)o.handleMessage(s[u])}break;default:if(!n)return l.warn("You received a malformed message from "+i+" of type "+t),void 0;var h=n.connectionId,o=this.getConnection(i,h);o&&o.pc?o.handleMessage(e):h?this._storeMessage(h,e):l.warn("You received an unrecognized message:",e)}},s.prototype._storeMessage=function(e,t){this._lostMessages[e]||(this._lostMessages[e]=[]),this._lostMessages[e].push(t)},s.prototype._getMessages=function(e){var t=this._lostMessages[e];return t?(delete this._lostMessages[e],t):[]},s.prototype.connect=function(e,t){if(this.disconnected)return l.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),this.emit("error",new Error("Cannot connect to new Peer after disconnecting from server.")),void 0;var n=new a(e,this,t);return this._addConnection(e,n),n},s.prototype.call=function(e,t,n){if(this.disconnected)return l.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),this.emit("error",new Error("Cannot connect to new Peer after disconnecting from server.")),void 0;if(!t)return l.error("To call a peer, you must provide a stream from your browser's `getUserMedia`."),void 0;n=n||{},n._stream=t;var i=new c(e,this,n);return this._addConnection(e,i),i},s.prototype._addConnection=function(e,t){this.connections[e]||(this.connections[e]=[]),this.connections[e].push(t)},s.prototype.getConnection=function(e,t){var n=this.connections[e];if(!n)return null;for(var i=0,r=n.length;r>i;i++)if(n[i].id===t)return n[i];return null},s.prototype._delayedAbort=function(e,t){var n=this;l.setZeroTimeout(function(){n._abort(e,t)})},s.prototype._abort=function(e,t){l.error("Aborting. Error:",t);var n=new Error(t);n.type=e,this.destroy(),this.emit("error",n)},s.prototype.destroy=function(){this.destroyed||(this._cleanup(),this.disconnect(),this.destroyed=!0)},s.prototype._cleanup=function(){for(var e=Object.keys(this.connections),t=0,n=e.length;n>t;t++)this._cleanupPeer(e[t]);this.emit("close")},s.prototype._cleanupPeer=function(e){for(var t=this.connections[e],n=0,i=t.length;i>n;n+=1)t[n].close()},s.prototype.disconnect=function(){var e=this;l.setZeroTimeout(function(){e.disconnected||(e.disconnected=!0,e.open=!1,e.socket&&e.socket.close(),e.id=null)})},e.Peer=s,l.inherits(a,r),a._idPrefix="dc_",a.prototype.initialize=function(e){this._dc=e,this._configureDataChannel()},a.prototype._configureDataChannel=function(){var e=this;l.supports.binary&&(this._dc.binaryType="arraybuffer"),this._dc.onopen=function(){l.log("Data channel connection success"),e.open=!0,e.emit("open")},!l.supports.reliable&&this.reliable&&(this._reliable=new o(this._dc,l.debug)),this._reliable?this._reliable.onmessage=function(t){e.emit("data",t)}:this._dc.onmessage=function(t){e._handleDataMessage(t)},this._dc.onclose=function(){l.log("DataChannel closed for:",e.peer),e.close()}},a.prototype._handleDataMessage=function(e){var t=this,n=e.data,i=n.constructor;if("binary"===this.serialization||"binary-utf8"===this.serialization){if(i===Blob)return l.blobToArrayBuffer(n,function(e){n=l.unpack(e),t.emit("data",n)}),void 0;if(i===ArrayBuffer)n=l.unpack(n);else if(i===String){var r=l.binaryStringToArrayBuffer(n);n=l.unpack(r)}}else"json"===this.serialization&&(n=JSON.parse(n));this.emit("data",n)},a.prototype.close=function(){this.open&&(this.open=!1,f.cleanup(this),this.emit("close"))},a.prototype.send=function(e){if(!this.open)return this.emit("error",new Error("Connection is not open. You should listen for the `open` event before sending messages.")),void 0;if(this._reliable)return this._reliable.send(e),void 0;var t=this;if("json"===this.serialization)this._dc.send(JSON.stringify(e));else if(-1!=="binary-utf8".indexOf(this.serialization)){var n="binary-utf8"===this.serialization,i=l.pack(e,n);l.supports.binary?this._dc.send(i):l.blobToBinaryString(i,function(e){t._dc.send(e)})}else this._dc.send(e)},a.prototype.handleMessage=function(e){var t=e.payload;switch(e.type){case"ANSWER":f.handleSDP(e.type,this,t.sdp);break;case"CANDIDATE":f.handleCandidate(this,t.candidate);break;default:l.warn("Unrecognized message type:",e.type,"from peer:",this.peer)}},l.inherits(c,r),c._idPrefix="mc_",c.prototype.addStream=function(e){l.log("Receiving stream",e),this.remoteStream=e,this.emit("stream",e)},c.prototype.handleMessage=function(e){var t=e.payload;switch(e.type){case"ANSWER":f.handleSDP(e.type,this,t.sdp),this.open=!0;break;case"CANDIDATE":f.handleCandidate(this,t.candidate);break;default:l.warn("Unrecognized message type:",e.type,"from peer:",this.peer)}},c.prototype.answer=function(e){if(this.localStream)return l.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?"),void 0;this.options._payload._stream=e,this.localStream=e,f.startConnection(this,this.options._payload);for(var t=this.provider._getMessages(this.id),n=0,i=t.length;i>n;n+=1)this.handleMessage(t[n]);this.open=!0},c.prototype.close=function(){this.open&&(this.open=!1,f.cleanup(this),this.emit("close"))};var f={pcs:{data:{},media:{}},queue:[]};f._idPrefix="pc_",f.startConnection=function(e,t){var n=f._getPeerConnection(e,t);if("media"===e.type&&t._stream&&n.addStream(t._stream),e.pc=n,t.originator){if("data"===e.type){var i={};l.supports.reliable&&!t.reliable?i={maxRetransmits:!1}:l.supports.reliable||(i={reliable:t.reliable});var r=n.createDataChannel(e.label,i);e.initialize(r)}l.supports.onnegotiationneeded||f._makeOffer(e)}else f.handleSDP("OFFER",e,t.sdp)},f._getPeerConnection=function(e,t){f.pcs[e.type]||l.error(e.type+" is not a valid connection type. Maybe you overrode the `type` property somewhere."),f.pcs[e.type][e.peer]||(f.pcs[e.type][e.peer]={}),f.pcs[e.type][e.peer];var n;return t.pc&&(n=f.pcs[e.type][e.peer][t.pc]),n&&"stable"===n.signalingState||(n=f._startPeerConnection(e)),n},f._startPeerConnection=function(e){l.log("Creating RTCPeerConnection.");var t=f._idPrefix+l.randomToken(),n={};return"data"!==e.type||l.supports.reliable?"media"===e.type&&(n={optional:[{DtlsSrtpKeyAgreement:!0}]}):n={optional:[{RtpDataChannels:!0}]},pc=new RTCPeerConnection(e.provider.options.config,n),f.pcs[e.type][e.peer][t]=pc,f._setupListeners(e,pc,t),pc},f._setupListeners=function(e,t){var n=e.peer,i=e.id,r=e.provider;l.log("Listening for ICE candidates."),t.onicecandidate=function(t){t.candidate&&(l.log("Received ICE candidates for:",e.peer),r.socket.send({type:"CANDIDATE",payload:{candidate:t.candidate,type:e.type,connectionId:e.id},dst:n}))},t.oniceconnectionstatechange=function(){switch(t.iceConnectionState){case"disconnected":case"failed":l.log("iceConnectionState is disconnected, closing connections to "+n),e.close();break;case"completed":t.onicecandidate=l.noop}},t.onicechange=t.oniceconnectionstatechange,l.log("Listening for `negotiationneeded`"),t.onnegotiationneeded=function(){l.log("`negotiationneeded` triggered"),"stable"==t.signalingState?f._makeOffer(e):l.log("onnegotiationneeded triggered when not stable. Is another connection being established?")},l.log("Listening for data channel"),t.ondatachannel=function(e){l.log("Received data channel");var t=e.channel,o=r.getConnection(n,i);o.initialize(t)},l.log("Listening for remote stream"),t.onaddstream=function(e){l.log("Received remote stream");var t=e.stream;r.getConnection(n,i).addStream(t)}},f.cleanup=function(e){l.log("Cleaning up PeerConnection to "+e.peer);var t=e.pc;!t||"closed"===t.readyState&&"closed"===t.signalingState||(t.close(),e.pc=null)},f._makeOffer=function(e){var t=e.pc;t.createOffer(function(n){l.log("Created offer."),l.supports.reliable||"data"!==e.type||(n.sdp=o.higherBandwidthSDP(n.sdp)),t.setLocalDescription(n,function(){l.log("Set localDescription: offer","for:",e.peer),e.provider.socket.send({type:"OFFER",payload:{sdp:n,type:e.type,label:e.label,reliable:e.reliable,serialization:e.serialization,metadata:e.metadata,connectionId:e.id},dst:e.peer})},function(t){e.provider.emit("error",t),l.log("Failed to setLocalDescription, ",t)})},function(t){e.provider.emit("error",t),l.log("Failed to createOffer, ",t)},e.options.constraints)},f._makeAnswer=function(e){var t=e.pc;t.createAnswer(function(n){l.log("Created answer."),l.supports.reliable||"data"!==e.type||(n.sdp=o.higherBandwidthSDP(n.sdp)),t.setLocalDescription(n,function(){l.log("Set localDescription: answer","for:",e.peer),e.provider.socket.send({type:"ANSWER",payload:{sdp:n,type:e.type,connectionId:e.id},dst:e.peer})},function(t){e.provider.emit("error",t),l.log("Failed to setLocalDescription, ",t)})},function(t){e.provider.emit("error",t),l.log("Failed to create answer, ",t)})},f.handleSDP=function(e,t,n){n=new RTCSessionDescription(n);var i=t.pc;l.log("Setting remote description",n),i.setRemoteDescription(n,function(){l.log("Set remoteDescription:",e,"for:",t.peer),"OFFER"===e&&f._makeAnswer(t)},function(e){t.provider.emit("error",e),l.log("Failed to setRemoteDescription, ",e)})},f.handleCandidate=function(e,t){var n=t.candidate,i=t.sdpMLineIndex;e.pc.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:i,candidate:n})),l.log("Added ICE candidate for:",e.peer)
},l.inherits(u,r),u.prototype.start=function(e){this.id=e;var t=l.randomToken();this._httpUrl+="/"+e+"/"+t,this._wsUrl+="&id="+e+"&token="+t,this._startXhrStream(),this._startWebSocket()},u.prototype._startWebSocket=function(){var e=this;this._socket||(this._socket=new WebSocket(this._wsUrl),this._socket.onmessage=function(t){var n;try{n=JSON.parse(t.data)}catch(i){return l.log("Invalid server message",t.data),void 0}e.emit("message",n)},this._socket.onopen=function(){e._timeout&&(clearTimeout(e._timeout),setTimeout(function(){e._http.abort(),e._http=null},5e3)),e._sendQueuedMessages(),l.log("Socket open")})},u.prototype._startXhrStream=function(e){try{var t=this;this._http=new XMLHttpRequest,this._http._index=1,this._http._streamIndex=e||0,this._http.open("post",this._httpUrl+"/id?i="+this._http._streamIndex,!0),this._http.onreadystatechange=function(){2==this.readyState&&this.old&&(this.old.abort(),delete this.old),this.readyState>2&&200==this.status&&this.responseText&&t._handleStream(this)},this._http.send(null),this._setHTTPTimeout()}catch(n){l.log("XMLHttpRequest not available; defaulting to WebSockets")}},u.prototype._handleStream=function(e){var t=e.responseText.split("\n");if(e._buffer)for(;e._buffer.length>0;){var n=e._buffer.shift(),i=t[n];try{i=JSON.parse(i)}catch(r){e._buffer.shift(n);break}this.emit("message",i)}var o=t[e._index];if(o)if(e._index+=1,e._index===t.length)e._buffer||(e._buffer=[]),e._buffer.push(e._index-1);else{try{o=JSON.parse(o)}catch(r){return l.log("Invalid server message",o),void 0}this.emit("message",o)}},u.prototype._setHTTPTimeout=function(){var e=this;this._timeout=setTimeout(function(){var t=e._http;e._wsOpen()?t.abort():(e._startXhrStream(t._streamIndex+1),e._http.old=t)},25e3)},u.prototype._wsOpen=function(){return this._socket&&1==this._socket.readyState},u.prototype._sendQueuedMessages=function(){for(var e=0,t=this._queue.length;t>e;e+=1)this.send(this._queue[e])},u.prototype.send=function(e){if(!this.disconnected){if(!this.id)return this._queue.push(e),void 0;if(!e.type)return this.emit("error","Invalid message"),void 0;var t=JSON.stringify(e);if(this._wsOpen())this._socket.send(t);else{var n=new XMLHttpRequest,i=this._httpUrl+"/"+e.type.toLowerCase();n.open("post",i,!0),n.setRequestHeader("Content-Type","application/json"),n.send(t)}}},u.prototype.close=function(){!this.disconnected&&this._wsOpen()&&(this._socket.close(),this.disconnected=!0)}}(this);